<!--
  Tailwind CSS Safelist for movieSizeClass
  sm:w-1/2
  lg:w-1/3
  lg:w-1/2
-->

<div
  x-data="{
      weeks: [],
      loading: true,
      error: false,
      sectionTitles: <%= JSON.stringify(sectionTitles) ?? {} %>,
      movieSizeClass: function (week, max) {
        if (week.movies.length == 1) {
          return 'w-full';
        }

        return 'w-1/' + Math.min(week.movies.length, max);
      },
      movieSizeClasses: function (week) {
        const sm = this.movieSizeClass(week, 2);
        const lg = this.movieSizeClass(week, 3);
        const xl = week.movies.length == 1 ? 'w-full' : 'w-1/3';
        const xxl = week.movies.length == 1 ? 'w-full' : 'w-1/4';

        return `w-full sm:${sm} lg:${lg} xl:${xl} 2xl:${xxl}`;
      },
      titleSize: function (movie) {
        return movie.title.length > 20 ? 'text-xl' : 'text-2xl';
      },
      weekTitle: function (week) {
        return week.isSkipped ? 'No movies this week!' : week.theme;
      },
      reload: function () {
        this.loading = true;
        this.error = false;
        this.weeks = fetch('<%= fetchUrl %>')
          .then(response => {
            if (!response.ok) {
              console.error('Error fetching week data: ', response.status, response.statusText);
              this.error = true;
              return Promise.resolve([]);
            }

            return response.json();
          })
          .then(data => {
            this.weeks = data;
            this.loading = false;
            const rsvpWeek = this.rsvpWeek();
            if (!rsvpWeek) { return; }
            const week = this.weeks.find(week => week.weekId === rsvpWeek);
            if (!week) { return; }

            $dispatch('open-modal', { week });
          });
      },
      rsvpWeek: function () {
        return new URLSearchParams(window.location.search).get('rsvp');
      },
      convertToKebabCase: function (titleCase) {
        return titleCase
          .replace(/\s+/g, '-')
          .toLowerCase();
      }
    }"
    x-init="reload()"
>
  <template x-if="loading">
    <%- include('loading') %>
  </template>

  <template x-if="error">
    <%- include('error') %>
  </template>

  <template x-for="[index, week] in Object.entries(weeks)">
    <div>
      <%- include('section_title') %>

      <%- include('week', { showEventDetails }); %>
    </div>
  </template>
</div>
